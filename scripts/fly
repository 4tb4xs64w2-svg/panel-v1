-- Fly Core - Solo vuelo horizontal WASD/flechas - Velocidad base 18 (sin GUI, sin reset al respawn)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer

-- Variables globales para control desde tu panel
_G.FlyEnabled = false
_G.FlySpeed   = 18        -- Velocidad por defecto

-- Estados internos
local flying = false
local bg, bv
local ctrl = {f = 0, b = 0, l = 0, r = 0}
local lastctrl = {f = 0, b = 0, l = 0, r = 0}
local speed = 0
local maxspeed = 50

local character
local humanoid
local torso
local isR6

-- Función para actualizar referencias al personaje actual
local function updateCharacterRefs()
    character = player.Character
    if not character then return false end
    
    humanoid = character:FindFirstChildWhichIsA("Humanoid")
    if not humanoid then return false end
    
    isR6 = humanoid.RigType == Enum.HumanoidRigType.R6
    torso = isR6 and character:FindFirstChild("Torso") or character:FindFirstChild("UpperTorso")
    
    return torso ~= nil
end

local function startFly()
    if flying or not updateCharacterRefs() then return end
    flying = true

    humanoid.PlatformStand = true

    bg = Instance.new("BodyGyro")
    bg.Parent = torso
    bg.P = 9e4
    bg.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
    bg.CFrame = torso.CFrame

    bv = Instance.new("BodyVelocity")
    bv.Parent = torso
    bv.Velocity = Vector3.new(0, 0.1, 0)
    bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)

    if character:FindFirstChild("Animate") then
        character.Animate.Disabled = true
    end
    for _, track in ipairs(humanoid:GetPlayingAnimationTracks()) do
        track:AdjustSpeed(0)
    end

    local connection
    connection = RunService.RenderStepped:Connect(function()
        if not _G.FlyEnabled then
            connection:Disconnect()
            stopFly()
            return
        end

        if not updateCharacterRefs() then
            connection:Disconnect()
            flying = false
            return
        end

        if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
            speed = speed + 0.5 + (speed / maxspeed)
            if speed > maxspeed then speed = maxspeed end
        elseif speed ~= 0 then
            speed = speed - 1
            if speed < 0 then speed = 0 end
        end

        local cam = workspace.CurrentCamera
        if (ctrl.l + ctrl.r) ~= 0 or (ctrl.f + ctrl.b) ~= 0 then
            bv.Velocity = (
                (cam.CFrame.LookVector * (ctrl.f + ctrl.b)) +
                ((cam.CFrame * CFrame.new(ctrl.l + ctrl.r, (ctrl.f + ctrl.b) * 0.2, 0).Position) - cam.CFrame.Position)
            ) * speed * _G.FlySpeed
            lastctrl = {f = ctrl.f, b = ctrl.b, l = ctrl.l, r = ctrl.r}
        elseif speed ~= 0 then
            bv.Velocity = (
                (cam.CFrame.LookVector * (lastctrl.f + lastctrl.b)) +
                ((cam.CFrame * CFrame.new(lastctrl.l + lastctrl.r, (lastctrl.f + lastctrl.b) * 0.2, 0).Position) - cam.CFrame.Position)
            ) * speed * _G.FlySpeed
        else
            bv.Velocity = Vector3.new(0, 0, 0)
        end

        bg.CFrame = cam.CFrame * CFrame.Angles(-math.rad((ctrl.f + ctrl.b) * 50 * speed / maxspeed), 0, 0)
    end)
end

local function stopFly()
    if not flying then return end
    flying = false

    if bg then bg:Destroy() end
    if bv then bv:Destroy() end

    if humanoid then
        humanoid.PlatformStand = false
    end

    if character and character:FindFirstChild("Animate") then
        character.Animate.Disabled = false
    end

    if humanoid then
        for _, track in ipairs(humanoid:GetPlayingAnimationTracks()) do
            track:AdjustSpeed(1)
        end
    end

    ctrl = {f = 0, b = 0, l = 0, r = 0}
    lastctrl = {f = 0, b = 0, l = 0, r = 0}
    speed = 0
end

-- Controles WASD / flechas
UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == Enum.KeyCode.W or input.KeyCode == Enum.KeyCode.Up then
        ctrl.f = 1
    elseif input.KeyCode == Enum.KeyCode.S or input.KeyCode == Enum.KeyCode.Down then
        ctrl.b = -1
    elseif input.KeyCode == Enum.KeyCode.A or input.KeyCode == Enum.KeyCode.Left then
        ctrl.l = -1
    elseif input.KeyCode == Enum.KeyCode.D or input.KeyCode == Enum.KeyCode.Right then
        ctrl.r = 1
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.W or input.KeyCode == Enum.KeyCode.Up then
        ctrl.f = 0
    elseif input.KeyCode == Enum.KeyCode.S or input.KeyCode == Enum.KeyCode.Down then
        ctrl.b = 0
    elseif input.KeyCode == Enum.KeyCode.A or input.KeyCode == Enum.KeyCode.Left then
        ctrl.l = 0
    elseif input.KeyCode == Enum.KeyCode.D or input.KeyCode == Enum.KeyCode.Right then
        ctrl.r = 0
    end
end)

-- Monitoreo constante del toggle
RunService.Heartbeat:Connect(function()
    if _G.FlyEnabled and not flying then
        startFly()
    elseif not _G.FlyEnabled and flying then
        stopFly()
    end
end)

-- Notificación opcional (puedes quitarla)
player:WaitForChild("PlayerGui"):WaitForChild("StarterGui"):SetCore("SendNotification", {
    Title = "Fly Cargado",
    Text = "Velocidad: 18\nActiva con _G.FlyEnabled = true\nNo se detiene al morir/respawn",
    Duration = 4
})
