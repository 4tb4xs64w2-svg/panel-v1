-- Fly inmediato al activar - WASD/flechas - No resetea al morir
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

local player = Players.LocalPlayer

_G.FlyEnabled = false
_G.FlySpeed = 18

local flying = false
local bg, bv
local ctrl = {f = 0, b = 0, l = 0, r = 0}
local lastctrl = {f = 0, b = 0, l = 0, r = 0}
local speed = 0
local maxspeed = 50

local character
local humanoid
local torso

local function updateRefs()
    character = player.Character
    if not character then return false end
    humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return false end
    torso = character:FindFirstChild("HumanoidRootPart") or character:FindFirstChild("Torso") or character:FindFirstChild("UpperTorso")
    return torso ~= nil
end

local function startFly()
    if flying or not updateRefs() then return end
    flying = true

    humanoid.PlatformStand = true

    bg = Instance.new("BodyGyro", torso)
    bg.P = 90000
    bg.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
    bg.CFrame = torso.CFrame

    bv = Instance.new("BodyVelocity", torso)
    bv.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    bv.Velocity = Vector3.new(0, 25, 0)  -- Impulso inicial para subir de una

    local conn
    conn = RunService.RenderStepped:Connect(function()
        if not _G.FlyEnabled then conn:Disconnect() stopFly() return end
        if not updateRefs() then conn:Disconnect() flying = false return end

        if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
            speed = math.min(maxspeed, speed + 1 + speed/25)
        elseif speed > 0 then
            speed = math.max(0, speed - 2)
        end

        local cam = workspace.CurrentCamera
        local move = (cam.CFrame.LookVector * (ctrl.f - ctrl.b)) + (cam.CFrame.RightVector * (ctrl.r - ctrl.l))
        bv.Velocity = move * speed * _G.FlySpeed

        bg.CFrame = cam.CFrame
    end)
end

local function stopFly()
    if not flying then return end
    flying = false
    if bg then bg:Destroy() end
    if bv then bv:Destroy() end
    if humanoid then humanoid.PlatformStand = false end
    ctrl = {f=0,b=0,l=0,r=0}
    speed = 0
end

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    local k = input.KeyCode
    if k == Enum.KeyCode.W or k == Enum.KeyCode.Up then ctrl.f = 1
    elseif k == Enum.KeyCode.S or k == Enum.KeyCode.Down then ctrl.b = 1
    elseif k == Enum.KeyCode.A or k == Enum.KeyCode.Left then ctrl.l = 1
    elseif k == Enum.KeyCode.D or k == Enum.KeyCode.Right then ctrl.r = 1
    end
end)

UserInputService.InputEnded:Connect(function(input)
    local k = input.KeyCode
    if k == Enum.KeyCode.W or k == Enum.KeyCode.Up then ctrl.f = 0
    elseif k == Enum.KeyCode.S or k == Enum.KeyCode.Down then ctrl.b = 0
    elseif k == Enum.KeyCode.A or k == Enum.KeyCode.Left then ctrl.l = 0
    elseif k == Enum.KeyCode.D or k == Enum.KeyCode.Right then ctrl.r = 0
    end
end)

RunService.Heartbeat:Connect(function()
    if _G.FlyEnabled and not flying then startFly()
    elseif not _G.FlyEnabled and flying then stopFly()
    end
end)

print("[FLY] Cargado - Activa con _G.FlyEnabled = true")
